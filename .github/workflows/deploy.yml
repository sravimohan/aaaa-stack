# This GitHub Actions workflow deploys to AWS ECS Fargate Cluster.
# It is triggered on manual dispatch.
# Required Secrets:
# - AWS_REGION: AWS region where the ECR repository is located (e.g., us-west-2).
# - AWS_DEPLOY_ROLE_ARN_TO_ASSUME: The ARN of the IAM role to assume for GitHub Actions.
# - AWS_ECR_REPOSITORY_URI: The URI of the ECR repository (e.g., 999999999999.dkr.ecr.ap-southeast-2.amazonaws.com/aaaa-stack).

name: Deploy

on:
  workflow_dispatch:
    inputs:
      imageTag:
        description: "Image tag to deploy"
        required: false
        default: ""
  push:
    branches:
      - ci

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure aws credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-session-name: GitHubActionsRoleSession
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN_TO_ASSUME }}

      # Setup Node.js for AWS CDK
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      # Deploy with AWS CDK
      - name: Deploy with AWS CDK
        working-directory: ./aws/app-cdk
        run: |
          npm ci
          npm run cdk synth
          npm run cdk deploy --all -- --require-approval never -- --parameters \
            AcmCertificateArn="${{ secrets.AWS_ACM_CERTIFICATE_ARN }}" \
            EcrRepositoryArn="${{ secrets.AWS_ECR_REPOSITORY_ARN }}" \
            ImageTag="${{ github.event.inputs.imageTag }}" \
        env:
          # environment variables needed for CDK deployment
          CDK_DEFAULT_ACCOUNT: "${{ secrets.AWS_ACCOUNT_ID }}"
          CDK_DEFAULT_REGION: "${{ secrets.AWS_REGION }}"
